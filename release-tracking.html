<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Release Tracker</title>
<style>
  :root {
    --bg:#0f1115;
    --panel:#171a21;
    --muted:#9aa4af;
    --text:#e8eef2;
    --accent-2:#5aa2f6;
    --border:#2a2f3a;
    --input:#1f2430;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:24px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  h1{
    margin:0 0 16px;
    font-size:20px;
    font-weight:700;
  }
  .app{
    max-width:none;
    width: calc(100% - 40px);
    margin:0 auto;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .row{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }
  label{
    font-size:13px;
    color:var(--muted);
  }
  input[type="text"],textarea{
    width:100%;
    background:var(--input);
    color:var(--text);
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
  }
  input[type="text"]:focus,textarea:focus{
    border-color:var(--accent-2);
  }
  .field{
    flex:1 1 320px;
  }
  .controls{
    display:flex;
    gap:6px;
    align-items:end;
    flex-wrap:nowrap;
  }
  button{
    border:1px solid var(--border);
    background:#1d2330;
    color:var(--text);
    padding:8px 10px;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
    transition:transform .02s ease,border-color .2s ease,background .15s ease;
    min-width:0;
  }
  button.primary,
  button.success,
  button.danger{
    background:#1d2330;
    color:var(--text);
    border:1px solid var(--border);
  }
  button:active{
    transform:translateY(1px);
  }
  button:disabled{
    opacity:0.45;
    cursor:default;
  }
  .table-wrap{
    margin-top:18px;
    overflow:auto;
    border:1px solid var(--border);
    border-radius:12px;
  }
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:980px;
    background:#121621;
    table-layout:fixed;
  }
  thead th{
    position:sticky;
    top:0;
    z-index:1;
    background:#161b27;
    color:#cfd8e3;
    text-align:left;
    font-weight:600;
    padding:12px;
    border-bottom:1px solid var(--border);
    font-size:13px;
  }
  tbody td{
    padding:10px 12px;
    border-bottom:1px solid var(--border);
    vertical-align:middle;
    font-size:14px;
  }
  tbody tr:hover td{
    background:#141a26;
  }

  /* Highlight: orange (not in PRD yet), green (PRD deployed) */
  tbody tr.dep-target-not-prd td{
    background:#3a2813;
  }
  tbody tr.dep-target-prd td{
    background:#163421;
  }

  .service-cell{
    display:block;
  }
  .service-name{
    width:100%;
    background:transparent;
    border:none;
    color:var(--text);
    font-size:14px;
    padding:6px 8px;
    border-radius:8px;
    outline:none;
  }
  .service-name:focus{
    background:#141a20;
    border:1px solid var(--accent-2);
  }
  .checkbox{
    text-align:center;
  }
  .checkbox input{
    width:18px;
    height:18px;
  }
  .notes{
    margin-top:16px;
  }
  .notes textarea{
    height:140px;
    resize:vertical;
  }
  .footer{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:14px;
  }
  .hint{
    color:var(--muted);
    font-size:12px;
  }

  .actions-cell{
    display:flex;
    gap:4px;
    flex-wrap:nowrap;
    align-items:center;
    justify-content:flex-start;
  }

  /* Status dot column */
  .status-cell{
    text-align:center;
    width:32px;
  }
  .status-dot{
    display:inline-block;
    width:12px;
    height:12px;
    border-radius:999px;
    background:#402020;
  }
  .dot-green{
    background:#19c25f;
  }
  .dot-red{
    background:#c23b19;
  }

  .link-panel{
    position:fixed;
    right:24px;
    bottom:24px;
    min-width:320px;
    max-width:420px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:12px;
    padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.6);
    z-index:1000;
  }
  .link-panel.hidden{
    display:none;
  }
  .link-panel-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:8px;
  }
  .link-panel input[type="text"]{
    margin-top:4px;
  }
  .link-panel-buttons{
    display:flex;
    gap:8px;
    justify-content:flex-end;
    margin-top:10px;
  }
</style>
</head>
<body>
  <div class="app">
    <h1>Release Tracker</h1>

    <div class="row" style="margin-bottom:10px;">
      <div class="field">
        <label for="releaseName">Release name</label>
        <input id="releaseName" type="text" placeholder="e.g. 2025.08.15 Platform Release"/>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="serviceInput">Add service</label>
        <input id="serviceInput" type="text" placeholder="e.g. user-profile-service"/>
      </div>
      <div class="controls">
        <button
          id="addServiceBtn"
          class="primary"
          title="Add service"
          aria-label="Add service"
        >‚ûï</button>
        <button
          id="clearAllBtn"
          class="danger"
          title="Clear all services"
          aria-label="Clear all services"
        >üßπ</button>
        <button
          id="sortBtn"
          title="Order services by dependencies"
          aria-label="Order services by dependencies"
        >‚¨áÔ∏è</button>
        <button
          id="loadBtn"
          title="Load from file"
          aria-label="Load from file"
        >üìÇ</button>
        <button
          id="saveBtn"
          class="success"
          title="Save to .txt"
          aria-label="Save to .txt"
        >üíæ</button>
        <input id="fileInput" type="file" accept=".txt,text/plain" style="display:none"/>
      </div>
    </div>

    <div class="table-wrap">
      <table id="servicesTable" aria-label="Services release stages">
        <thead>
          <tr>
            <th style="width:32px;"></th>
            <th style="width:260px;">Service</th>
            <th style="width:260px;">Depends on</th>
            <th>RC cut</th>
            <th>STG deploy</th>
            <th>STG signed off</th>
            <th>PRD deploy</th>
            <th>Done</th>
            <th style="min-width:160px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="notes">
      <label for="notes">Notes</label>
      <textarea id="notes" placeholder="Anything odd, risky, or worth remembering?"></textarea>
    </div>

    <div class="footer">
      <div class="hint">Tip: Press <strong>Enter</strong> to add a service quickly.</div>
      <div></div>
    </div>
  </div>

<script>
(() => {
  // Remaining stages (TST removed)
  const STAGES = [
    "RC cut",
    "STG deploy",
    "STG signed off",
    "PRD deploy",
    "Done"
  ];
  const STAGE_START_COL = 3; // columns: 0=status,1=service,2=depends,3+=stages

  const releaseNameEl = document.getElementById('releaseName');
  const serviceInputEl = document.getElementById('serviceInput');
  const addServiceBtn = document.getElementById('addServiceBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const sortBtn = document.getElementById('sortBtn');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const fileInput = document.getElementById('fileInput');
  const tbody = document.getElementById('tbody');

  // Link editor panel state
  let linkPanel = null;
  let linkInput = null;
  let linkSaveBtn = null;
  let linkCancelBtn = null;
  let currentLinkRow = null;

  function initLinkPanel() {
    if (linkPanel) return;

    linkPanel = document.createElement('div');
    linkPanel.className = 'link-panel hidden';

    const title = document.createElement('div');
    title.className = 'link-panel-title';
    title.textContent = 'Edit pipeline link';

    linkInput = document.createElement('input');
    linkInput.type = 'text';
    linkInput.placeholder = 'https://pipeline.example.com/run/123';

    const buttonsWrap = document.createElement('div');
    buttonsWrap.className = 'link-panel-buttons';

    linkCancelBtn = document.createElement('button');
    linkCancelBtn.type = 'button';
    linkCancelBtn.textContent = 'Cancel';

    linkSaveBtn = document.createElement('button');
    linkSaveBtn.type = 'button';
    linkSaveBtn.textContent = 'Save';

    buttonsWrap.appendChild(linkCancelBtn);
    buttonsWrap.appendChild(linkSaveBtn);

    linkPanel.appendChild(title);
    linkPanel.appendChild(linkInput);
    linkPanel.appendChild(buttonsWrap);

    document.body.appendChild(linkPanel);

    linkCancelBtn.addEventListener('click', hideLinkPanel);
    linkSaveBtn.addEventListener('click', () => {
      if (!currentLinkRow) {
        hideLinkPanel();
        return;
      }
      const url = linkInput.value.trim();
      if (url) {
        currentLinkRow.dataset.link = url;
        if (currentLinkRow._openLinkBtn) {
          currentLinkRow._openLinkBtn.disabled = false;
        }
      } else {
        delete currentLinkRow.dataset.link;
        if (currentLinkRow._openLinkBtn) {
          currentLinkRow._openLinkBtn.disabled = true;
        }
      }
      hideLinkPanel();
    });

    linkInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        linkSaveBtn.click();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        hideLinkPanel();
      }
    });
  }

  function openLinkEditor(tr) {
    initLinkPanel();
    currentLinkRow = tr;
    linkInput.value = tr.dataset.link || '';
    linkPanel.classList.remove('hidden');
    linkInput.focus();
    linkInput.select();
  }

  function hideLinkPanel() {
    if (linkPanel) {
      linkPanel.classList.add('hidden');
    }
    currentLinkRow = null;
  }

  // ---- Utilities ----
  function formatTs(ts) {
    const d = new Date(ts);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const h = d.getHours();
    const m = String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm}/${yyyy} ${h}:${m}`;
  }

  function parseDateStr(s) {
    // Expect DD/MM/YYYY h:m
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2})$/);
    if (!m) return NaN;
    const [_, dd, MM, yyyy, hh, mm] = m;
    return new Date(Number(yyyy), Number(MM)-1, Number(dd), Number(hh), Number(mm), 0, 0).getTime();
  }

  // Dependency match helper:
  // token matches service name if:
  // - serviceName contains token at position 0 or after a space
  // - and is followed by end-of-string, space, or '('
  function dependencyMatchesService(depToken, serviceName) {
    const needle = depToken.trim().toLowerCase();
    const hay = serviceName.trim().toLowerCase();
    if (!needle || !hay) return false;

    let idx = hay.indexOf(needle);
    while (idx !== -1) {
      const beforeOk = (idx === 0) || hay[idx - 1] === ' ';
      const afterIdx = idx + needle.length;
      const afterChar = hay[afterIdx] || '';
      const afterOk = afterIdx === hay.length || afterChar === ' ' || afterChar === '(';

      if (beforeOk && afterOk) return true;

      idx = hay.indexOf(needle, idx + 1);
    }
    return false;
  }

  function makeCheckbox(stage, serviceName='') {
    const td = document.createElement('td');
    td.className = 'checkbox';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.setAttribute('aria-label', `${stage} complete for ${serviceName || 'this service'}`);
    cb.addEventListener('change', () => {
      if (cb.checked) {
        cb.dataset.ts = String(Date.now());
      } else {
        delete cb.dataset.ts;
      }
      recomputeDependencyState();
    });
    td.appendChild(cb);
    return td;
  }

  function recomputeDependencyState() {
    const rows = [...tbody.querySelectorAll('tr')];

    // Clear existing highlights
    rows.forEach(tr => {
      tr.classList.remove('dep-target-not-prd', 'dep-target-prd');
    });

    if (rows.length === 0) return;

    const prdIndex = STAGES.indexOf('PRD deploy');

    // Build service list
    const services = rows.map(tr => {
      const input = tr.querySelector('.service-name');
      const name = input ? input.value.trim() : '';
      let prdChecked = false;
      if (prdIndex !== -1) {
        const cellIndex = STAGE_START_COL + prdIndex;
        const cb = tr.cells[cellIndex]?.querySelector('input[type="checkbox"]');
        prdChecked = !!(cb && cb.checked);
      }
      return { tr, name, prdChecked };
    }).filter(x => x.name);

    if (!services.length) {
      // still recompute dots (all will be considered as "no deps", so green)
      rows.forEach(tr => {
        const dot = tr._statusDot || tr.querySelector('.status-dot');
        if (!dot) return;
        dot.classList.remove('dot-red');
        dot.classList.add('dot-green');
      });
      return;
    }

    const highlightState = new Map(); // tr -> 'orange' | 'green'

    // For each row with dependencies, mark targets for highlight
    rows.forEach(tr => {
      const depInput = tr._dependsInput || tr.querySelector('.depends-input');
      if (!depInput) return;
      const raw = depInput.value.trim();
      if (!raw) return;

      const tokens = raw.split(',')
        .map(s => s.trim())
        .filter(Boolean);

      if (!tokens.length) return;

      tokens.forEach(token => {
        services.forEach(({ tr: targetTr, name, prdChecked }) => {
          if (!name) return;
          if (targetTr === tr) return;
          if (dependencyMatchesService(token, name)) {
            const color = prdChecked ? 'green' : 'orange';
            const prev = highlightState.get(targetTr);
            // Green wins over orange if conflicting
            if (!prev || (prev === 'orange' && color === 'green')) {
              highlightState.set(targetTr, color);
            }
          }
        });
      });
    });

    // Apply row highlight classes
    highlightState.forEach((color, tr) => {
      if (color === 'green') {
        tr.classList.add('dep-target-prd');
      } else {
        tr.classList.add('dep-target-not-prd');
      }
    });

    // Recompute status dots (per row)
    rows.forEach(tr => {
      const dot = tr._statusDot || tr.querySelector('.status-dot');
      if (!dot) return;

      const depInput = tr._dependsInput || tr.querySelector('.depends-input');
      const depRaw = depInput ? depInput.value.trim() : '';
      if (!depRaw) {
        // no dependencies => green
        dot.classList.remove('dot-red');
        dot.classList.add('dot-green');
        return;
      }

      const tokens = depRaw.split(',')
        .map(s => s.trim())
        .filter(Boolean);

      if (!tokens.length) {
        dot.classList.remove('dot-red');
        dot.classList.add('dot-green');
        return;
      }

      let anyMatch = false;
      let allMatchedArePrd = true;

      tokens.forEach(token => {
        services.forEach(({ name, prdChecked }) => {
          if (!name) return;
          if (dependencyMatchesService(token, name)) {
            anyMatch = true;
            if (!prdChecked) {
              allMatchedArePrd = false;
            }
          }
        });
      });

      const isGreen =
        !tokens.length        // should already be false here
        || !anyMatch          // deps exist but none are in table => treat as satisfied
        || allMatchedArePrd;  // all internal deps in PRD

      dot.classList.toggle('dot-green', isGreen);
      dot.classList.toggle('dot-red', !isGreen);
    });
  }

  // Row: [Status][Service][Depends on][stage1..n][Actions]
  function makeRow(serviceName='') {
    const tr = document.createElement('tr');

    // Status dot
    const tdStatus = document.createElement('td');
    tdStatus.className = 'status-cell';
    const dot = document.createElement('span');
    dot.className = 'status-dot dot-green';
    tdStatus.appendChild(dot);
    tr.appendChild(tdStatus);
    tr._statusDot = dot;

    // Service
    const tdService = document.createElement('td');
    tdService.className = 'service-cell';
    const input = document.createElement('input');
    input.className = 'service-name';
    input.type = 'text';
    input.value = serviceName;
    input.placeholder = 'service-name';
    input.setAttribute('aria-label', 'Service name');
    input.addEventListener('input', recomputeDependencyState);
    tdService.appendChild(input);
    tr.appendChild(tdService);

    // Depends on
    const tdDepends = document.createElement('td');
    const depInput = document.createElement('input');
    depInput.type = 'text';
    depInput.className = 'depends-input';
    depInput.placeholder = 'core-service, auth';
    depInput.setAttribute('aria-label', 'Depends on services');
    depInput.addEventListener('input', recomputeDependencyState);
    tdDepends.appendChild(depInput);
    tr.appendChild(tdDepends);
    tr._dependsInput = depInput;

    // Stages
    STAGES.forEach(stage => tr.appendChild(makeCheckbox(stage, serviceName)));

    // Actions
    const tdActions = document.createElement('td');
    tdActions.className = 'actions-cell';

    const editLinkBtn = document.createElement('button');
    editLinkBtn.type = 'button';
    editLinkBtn.textContent = 'üîó';
    editLinkBtn.title = 'Edit pipeline link';
    editLinkBtn.setAttribute('aria-label', 'Edit pipeline link');
    editLinkBtn.addEventListener('click', () => openLinkEditor(tr));

    const openLinkBtn = document.createElement('button');
    openLinkBtn.type = 'button';
    openLinkBtn.textContent = '‚Üó';
    openLinkBtn.title = 'Open pipeline link';
    openLinkBtn.setAttribute('aria-label', 'Open pipeline link');
    openLinkBtn.disabled = true;
    openLinkBtn.addEventListener('click', () => {
      const raw = (tr.dataset.link || '').trim();
      if (!raw) return;
      const url = /^https?:\/\//i.test(raw) ? raw : 'https://' + raw;
      try {
        window.open(url, '_blank', 'noopener');
      } catch (err) {
        console.error('Failed to open link', err);
      }
    });

    const removeBtn = document.createElement('button');
    removeBtn.className = 'danger';
    removeBtn.type = 'button';
    removeBtn.textContent = 'üóëÔ∏è';
    removeBtn.title = 'Remove service';
    removeBtn.setAttribute('aria-label', 'Remove service');
    removeBtn.addEventListener('click', () => {
      tr.remove();
      recomputeDependencyState();
    });

    tr._openLinkBtn = openLinkBtn;

    tdActions.appendChild(editLinkBtn);
    tdActions.appendChild(openLinkBtn);
    tdActions.appendChild(removeBtn);
    tr.appendChild(tdActions);

    return tr;
  }

  // ---- Add / Clear ----
  function addService() {
    const name = serviceInputEl.value.trim();
    if (!name) return;
    const tr = makeRow(name);
    tbody.appendChild(tr);
    serviceInputEl.value = '';
    serviceInputEl.focus();
    recomputeDependencyState();
  }

  addServiceBtn.addEventListener('click', addService);

  serviceInputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addService();
    }
  });

  clearAllBtn.addEventListener('click', () => {
    if (tbody.children.length === 0) return;
    if (confirm('Remove all services from this release?')) {
      tbody.innerHTML = '';
      recomputeDependencyState();
    }
  });

  // ---- Sort by dependency order ----
  function sortServicesByDependencies() {
    const rows = [...tbody.querySelectorAll('tr')];
    if (rows.length <= 1) return;

    const nodes = rows.map((tr) => {
      const name = tr.querySelector('.service-name')?.value.trim() || '';
      const depInput = tr._dependsInput || tr.querySelector('.depends-input');
      const depRaw = depInput ? depInput.value.trim() : '';
      const depTokens = depRaw.split(',')
        .map(s => s.trim())
        .filter(Boolean);
      return { tr, name, depTokens };
    });

    const n = nodes.length;
    const adj = Array.from({ length: n }, () => []);
    const indeg = Array(n).fill(0);
    let hasInternalDeps = false;

    // Build edges: dependency -> dependent
    nodes.forEach((node, i) => {
      node.depTokens.forEach(tok => {
        nodes.forEach((targetNode, j) => {
          if (!targetNode.name) return;
          if (i === j) return;
          if (dependencyMatchesService(tok, targetNode.name)) {
            adj[j].push(i);
            indeg[i]++;
            hasInternalDeps = true;
          }
        });
      });
    });

    if (!hasInternalDeps) {
      // No internal deps at all: do nothing
      return;
    }

    const result = [];
    const visited = Array(n).fill(false);
    const queue = [];

    // Start with nodes with indegree 0 in current order
    for (let i = 0; i < n; i++) {
      if (indeg[i] === 0) queue.push(i);
    }

    while (queue.length) {
      const i = queue.shift();
      if (visited[i]) continue;
      visited[i] = true;
      result.push(nodes[i]);
      adj[i].forEach(j => {
        indeg[j]--;
        if (indeg[j] === 0) queue.push(j);
      });
    }

    // In case of cycles, append remaining in original order
    if (result.length < n) {
      for (let i = 0; i < n; i++) {
        if (!visited[i]) {
          result.push(nodes[i]);
        }
      }
    }

    const frag = document.createDocumentFragment();
    result.forEach(node => frag.appendChild(node.tr));
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    recomputeDependencyState();
  }

  sortBtn.addEventListener('click', sortServicesByDependencies);

  // Helper: get rightmost checked stage using cell indexes (after status/service/depends)
  function getRightmostCheckedStageIndex(tr) {
    const cells = tr.cells;
    let last = -1;
    // stages start at STAGE_START_COL
    for (let i = 0; i < STAGES.length; i++) {
      const cellIndex = STAGE_START_COL + i;
      const cb = cells[cellIndex]?.querySelector('input[type="checkbox"]');
      if (cb && cb.checked) last = i;
    }
    return last; // -1 if none checked
  }

  // ---- Export ----
  function composeExportText() {
    const release = document.getElementById('releaseName').value.trim() || '';
    const lines = [];
    const border = '#############';
    lines.push(border, `# ${release} #`, border, '', 'Services:');

    [...document.querySelectorAll('#tbody tr')].forEach(tr => {
      const name = (tr.querySelector('.service-name')?.value || '').trim();
      if (!name) return;

      const lastIdx = getRightmostCheckedStageIndex(tr);
      const link = (tr.dataset.link || '').trim();
      const deps = (tr._dependsInput?.value || tr.querySelector('.depends-input')?.value || '').trim();
      let line;

      if (lastIdx === -1) {
        line = `* ${name} (NOT STARTED)`;
      } else {
        const stageName = STAGES[lastIdx];
        const cbCellIndex = STAGE_START_COL + lastIdx;
        const cb = tr.cells[cbCellIndex].querySelector('input[type="checkbox"]');
        let ts = Number(cb.dataset.ts || 0);
        if (!ts) {
          ts = Date.now();
          cb.dataset.ts = String(ts);
        }
        line = `* ${name} (${stageName} - ${formatTs(ts)})`;
      }

      const extras = [];
      if (link) extras.push(`link: ${link}`);
      if (deps) extras.push(`deps: ${deps}`);
      if (extras.length) {
        line += ' | ' + extras.join(' | ');
      }

      lines.push(line);
    });

    lines.push('', 'Notes:');
    lines.push(document.getElementById('notes').value || '');
    return lines.join('\n');
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safe = (filename || 'release').replace(/[^\w\-.]+/g, '_');
    a.href = url;
    a.download = `${safe}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  saveBtn.addEventListener('click', () => {
    const txt = composeExportText();
    const name = (releaseNameEl.value.trim() || 'release');
    download(`release-${name}`, txt);
  });

  // ---- Import (Load from file) ----
  loadBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    try {
      importFromText(text);
    } catch (err) {
      console.error(err);
      alert('Failed to load file. Please ensure it matches the exported format.');
    } finally {
      fileInput.value = '';
    }
  });

  function importFromText(text) {
    const lines = text.split(/\r?\n/);

    // 1) Release name
    const titleLine = lines.find(l => /^#\s.*\s#$/.test(l.trim()));
    const releaseName = titleLine ? titleLine.trim().replace(/^#\s/, '').replace(/\s#$/, '') : '';
    releaseNameEl.value = releaseName;

    // 2) Services block
    const servicesIdx = lines.findIndex(l => l.trim() === 'Services:');
    const notesIdx = lines.findIndex(l => l.trim() === 'Notes:');
    const serviceLines = (servicesIdx >= 0 && notesIdx > servicesIdx)
      ? lines.slice(servicesIdx + 1, notesIdx)
      : [];

    // 3) Notes
    const notesText = (notesIdx >= 0) ? lines.slice(notesIdx + 1).join('\n') : '';
    document.getElementById('notes').value = notesText;

    // Reset table
    tbody.innerHTML = '';

    serviceLines.forEach(raw => {
      const full = raw.trim();
      if (!full.startsWith('* ')) return;

      let line = full;
      let link = '';
      let depsText = '';

      // Split out optional " | ..." segments
      const pipeIdx = full.indexOf('|');
      if (pipeIdx !== -1) {
        line = full.slice(0, pipeIdx).trim(); // "* name (Stage - date)" or "* name (NOT STARTED)"
        const after = full.slice(pipeIdx + 1).trim(); // e.g. "link: URL | deps: foo, bar"
        const segments = after.split('|').map(s => s.trim());
        segments.forEach(seg => {
          const mLink = seg.match(/^link:\s*(.+)$/i);
          if (mLink) {
            link = mLink[1].trim();
          }
          const mDeps = seg.match(/^deps:\s*(.+)$/i);
          if (mDeps) {
            depsText = mDeps[1].trim();
          }
        });
      }

      // Extract name + bracket from main part
      const open = line.lastIndexOf('(');
      const close = open !== -1 ? line.indexOf(')', open + 1) : -1;
      let name, bracket;
      if (open !== -1 && close !== -1 && close > open) {
        name = line.slice(2, open).trim().replace(/\s+$/, '');
        bracket = line.slice(open + 1, close).trim();
      } else {
        name = line.slice(2).trim();
        bracket = '';
      }

      const tr = makeRow(name);
      if (link) {
        tr.dataset.link = link;
        if (tr._openLinkBtn) {
          tr._openLinkBtn.disabled = false;
        }
      }
      if (depsText && tr._dependsInput) {
        tr._dependsInput.value = depsText;
      }
      tbody.appendChild(tr);

      // If NOT STARTED -> leave all unchecked
      if (!bracket || /^NOT STARTED$/i.test(bracket)) return;

      // Expect "Stage - DD/MM/YYYY h:m"
      const sep = bracket.indexOf(' - ');
      if (sep === -1) return;
      const stageName = bracket.slice(0, sep).trim();
      const dateStr = bracket.slice(sep + 3).trim();
      const ts = parseDateStr(dateStr);
      if (!stageName || Number.isNaN(ts)) return;

      const stageIdx = STAGES.indexOf(stageName);
      if (stageIdx === -1) return;

      const cbs = [...tr.querySelectorAll('td.checkbox input[type="checkbox"]')];
      for (let i = 0; i <= stageIdx && i < cbs.length; i++) {
        cbs[i].checked = true;
        cbs[i].dataset.ts = String(ts);
      }
    });

    if (tbody.children.length === 0) tbody.appendChild(makeRow(''));
    recomputeDependencyState();
  }

  // Seed an empty row initially
  tbody.appendChild(makeRow(''));
  recomputeDependencyState();
})();
</script>
</body>
</html>
